<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.industry.mapper.TitleEvaluationTransferMapper">

    <insert id="insertTransferOrder" useGeneratedKeys="true" keyProperty="id">
        insert into construction_industry_api.t_title_evaluation_transfer
        (title_evaluation_order_id, customer_name, orderno, bank_name, open_bank, account_name, bank_card_no,
         transfer_amount,
         funds_purpose, creator_id, gmt_create, regenerator_id, gmt_modified, remark)
        values (#{titleEvaluationOrderId},
                #{customerName},
                #{orderno},
                #{bankName},
                #{openBank},
                #{accountName},
                #{bankCardNo},
                #{transferAmount},
                #{fundsPurpose},
                #{creatorId},
                #{gmtCreate},
                #{regeneratorId},
                #{gmtModified},
                #{remark})
    </insert>

    <resultMap id="getListTransfersByOrderIdMap" type="TitleEvaluationTransferDO">
        <id column="id" property="id"/>
        <collection property="listImages" select="selectListImagesById" column="id" ofType="PictureTempDO"/>
        <collection property="listAuditRecords" select="selectListAuditRecordsById" column="id" ofType="PictureTempDO"/>
    </resultMap>

    <select id="selectListImagesById" resultType="PictureTempDO">
        select id,
               resource_id,
               namespace,
               type,
               name,
               url,
               creator_id,
               gmt_create
        from construction_industry_api.t_picture
        where resource_id = #{id}
          and namespace = 'title-evaluation'
          and type = 'order-transfer'
    </select>

    <select id="selectListAuditRecordsById" resultType="TitleEvaluationApprovalFlowDO">
        select id,
               title_evaluation_transfer_id,
               audit_status,
               audit_result,
               approval_opinion,
               next_audit_role_id,
               creator_id,
               gmt_create
        from construction_industry_api.t_title_evaluation_approval_flow
        where title_evaluation_transfer_id = #{id}
    </select>
    <select id="getListTransfersByOrderId" resultType="TitleEvaluationTransferDO"
            resultMap="getListTransfersByOrderIdMap">
        select id,
               title_evaluation_order_id,
               bank_name,
               customer_name,
               open_bank,
               account_name,
               bank_card_no,
               transfer_amount,
               funds_purpose,
               application_status,
               creator_id,
               gmt_create,
               regenerator_id,
               gmt_modified,
               remark
        from construction_industry_api.t_title_evaluation_transfer
        where title_evaluation_order_id = #{id}
    </select>
    <select id="selectListTransferRecordsById" resultType="TitleEvaluationTransferDO"
            resultMap="getListTransfersByOrderIdMap">
        select id,
               title_evaluation_order_id,
               bank_name,
               customer_name,
               open_bank,
               account_name,
               bank_card_no,
               transfer_amount,
               funds_purpose,
               application_status,
               creator_id,
               gmt_create,
               regenerator_id,
               gmt_modified,
               remark
        from construction_industry_api.t_title_evaluation_transfer
        where title_evaluation_order_id = #{title_evaluation_order_id}
    </select>
    <select id="getCount" resultType="Long">
        select count(*)
        from construction_industry_api.t_title_evaluation_transfer
    </select>
    <select id="getListTransferRecordsPage" resultType="TitleEvaluationTransferDO">
        select id,
               title_evaluation_order_id,
               customer_name,
               orderno,
               bank_name,
               customer_name,
               open_bank,
               account_name,
               bank_card_no,
               transfer_amount,
               funds_purpose,
               application_status,
               creator_id,
               gmt_create,
               regenerator_id,
               gmt_modified,
               remark
        from construction_industry_api.t_title_evaluation_transfer
        order by id desc
        limit #{page.currentPage},#{page.pageSize}
    </select>

    <resultMap id="getDetailByIdMap" type="TitleEvaluationTransferDO">
        <id column="id" property="id"/>
        <result column="title_evaluation_order_id" property="titleEvaluationOrderId"/>
        <collection property="listAuditRecords" select="selectListAuditRecordsById" column="id"
                    ofType="TitleEvaluationApprovalFlowDO">
        </collection>
        <collection property="listTransferRecords" select="selectListTransferRecordsById" column="title_evaluation_order_id"
                    ofType="TitleEvaluationTransferDO">
        </collection>
    </resultMap>
    
    <select id="getDetailById" resultType="TitleEvaluationTransferDO" resultMap="getDetailByIdMap">
        select id,
               title_evaluation_order_id,
               customer_name,
               orderno,
               bank_name,
               customer_name,
               open_bank,
               account_name,
               bank_card_no,
               transfer_amount,
               funds_purpose,
               application_status,
               creator_id,
               gmt_create,
               regenerator_id,
               gmt_modified,
               remark
        from construction_industry_api.t_title_evaluation_transfer
        where id = #{id}
    </select>

</mapper>
